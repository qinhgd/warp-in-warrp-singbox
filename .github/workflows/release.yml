# .github/workflows/release.yml

name: Build, Push to GHCR & Upload to Release

# è§¦å‘æ¡ä»¶ï¼šå½“åœ¨ GitHub ä»“åº“çš„ "Releases" é¡µé¢ä¸Šå‘å¸ƒä¸€ä¸ªæ–°çš„ Release æ—¶è§¦å‘
on:
  release:
    types: [published]

# ä¸ºå·¥ä½œæµè®¾ç½®æƒé™
permissions:
  contents: write      # å…è®¸ä¸Šä¼ æ–‡ä»¶åˆ° Release
  packages: write      # å…è®¸æ¨é€åˆ° GitHub Container Registry (GHCR)

# ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†
env:
  # å®šä¹‰é•œåƒçš„åŸºç¡€åç§°ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ "ç”¨æˆ·å/ä»“åº“å"
  IMAGE_BASENAME: ghcr.io/${{ github.repository_owner }}/singbox-wgcf-proxy

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ å‡†å¤‡ç‰ˆæœ¬å·å’Œé•œåƒæ ‡ç­¾
        id: prep
        run: |
          # ä» Release æ ‡ç­¾ (å¦‚ v1.2.3) ä¸­æå–çº¯ç‰ˆæœ¬å· (1.2.3)
          VERSION_NUM=${{ github.ref_name }}
          VERSION_NUM=${VERSION_NUM#v}
          
          # å®šä¹‰å°†è¦ç”Ÿæˆçš„ .tar æ–‡ä»¶å
          TAR_NAME="singbox-wgcf-proxy-arm64-${{ github.ref_name }}.tar"
          
          # å®šä¹‰å®Œæ•´çš„é•œåƒæ ‡ç­¾ï¼Œä¾‹å¦‚ï¼šghcr.io/user/repo:latest, ghcr.io/user/repo:v1.2.3
          IMAGE_TAGS="${{ env.IMAGE_BASENAME }}:latest,${{ env.IMAGE_BASENAME }}:${{ github.ref_name }}"
          
          # å°†å˜é‡è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION_NUM=${VERSION_NUM}" >> $GITHUB_ENV
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAGS=${IMAGE_TAGS}" >> $GITHUB_ENV

      - name: ğŸ› ï¸ æ„å»ºã€æ¨é€å¹¶æ‰“åŒ…é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: true
          tags: ${{ env.IMAGE_TAGS }}
          # å…³é”®ä¸€æ­¥ï¼šå°† Release ç‰ˆæœ¬å·ä½œä¸ºæ„å»ºå‚æ•°ä¼ é€’ç»™ Dockerfile
          build-args: |
            SINGBOX_VERSION=${{ env.VERSION_NUM }}
          # ä¼˜åŒ–ï¼šåŒæ—¶å°†æ„å»ºç»“æœå¯¼å‡ºä¸º .tar æ–‡ä»¶ï¼Œé¿å…äºŒæ¬¡æ„å»º
          outputs: type=docker,dest=${{ env.TAR_NAME }}

      - name: â¬†ï¸ ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          # ä¸Šä¼ æˆ‘ä»¬åˆšåˆšå¯¼å‡ºçš„ .tar æ–‡ä»¶
          files: ${{ env.TAR_NAME }}
