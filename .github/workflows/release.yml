# .github/workflows/release.yml

name: Build, Push to GHCR & Upload to Release

on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write

env:
  # 定义镜像的基础名称
  IMAGE_BASENAME: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: 🧾 检出仓库代码
        uses: actions/checkout@v4

      - name: 🔧 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔑 登录到 GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ==================== ↓↓↓ 这里是修改的部分 ↓↓↓ ====================
      # 不再需要准备版本号，逻辑大大简化
      - name: 📦 准备镜像标签和文件名
        id: prep
        run: |
          TAR_NAME="${{ github.event.repository.name }}-${{ github.ref_name }}.tar"
          IMAGE_TAGS="${{ env.IMAGE_BASENAME }}:latest,${{ env.IMAGE_BASENAME }}:${{ github.ref_name }}"
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAGS=${IMAGE_TAGS}" >> $GITHUB_ENV
      
      # 构建时不再需要 build-args
      - name: 🛠️ 构建、推送并打包镜像
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: true
          tags: ${{ env.IMAGE_TAGS }}
          outputs: type=docker,dest=${{ env.TAR_NAME }}
      # ==================== ↑↑↑ 这里是修改的部分 ↑↑↑ ====================

      - name: ⬆️ 上传打包文件到 Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.TAR_NAME }}
