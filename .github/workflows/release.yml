# .github/workflows/release.yml

name: Build, Push to GHCR & Upload to Release

on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write

env:
  # å®šä¹‰é•œåƒçš„åŸºç¡€åç§°
  IMAGE_BASENAME: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ==================== â†“â†“â†“ è¿™é‡Œæ˜¯ä¿®æ”¹çš„éƒ¨åˆ† â†“â†“â†“ ====================
      # ä¸å†éœ€è¦å‡†å¤‡ç‰ˆæœ¬å·ï¼Œé€»è¾‘å¤§å¤§ç®€åŒ–
      - name: ğŸ“¦ å‡†å¤‡é•œåƒæ ‡ç­¾å’Œæ–‡ä»¶å
        id: prep
        run: |
          TAR_NAME="${{ github.event.repository.name }}-${{ github.ref_name }}.tar"
          IMAGE_TAGS="${{ env.IMAGE_BASENAME }}:latest,${{ env.IMAGE_BASENAME }}:${{ github.ref_name }}"
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAGS=${IMAGE_TAGS}" >> $GITHUB_ENV
      
      # æ„å»ºæ—¶ä¸å†éœ€è¦ build-args
      - name: ğŸ› ï¸ æ„å»ºã€æ¨é€å¹¶æ‰“åŒ…é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: true
          tags: ${{ env.IMAGE_TAGS }}
          outputs: type=docker,dest=${{ env.TAR_NAME }}
      # ==================== â†‘â†‘â†‘ è¿™é‡Œæ˜¯ä¿®æ”¹çš„éƒ¨åˆ† â†‘â†‘â†‘ ====================

      - name: â¬†ï¸ ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.TAR_NAME }}
